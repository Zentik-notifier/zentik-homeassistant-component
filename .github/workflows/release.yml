name: CI / Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Hassfest
        uses: home-assistant/actions/hassfest@master

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands description topics

  release:
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version + check if release exists
        id: version
        shell: bash
        run: |
          set -euo pipefail

          VERSION="$(python -c 'import json, pathlib; p = pathlib.Path("custom_components/zentik_notifier/manifest.json"); print(json.loads(p.read_text(encoding="utf-8"))["version"])')"
          TAG="v${VERSION}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q .; then
            echo "release_needed=false" >> "$GITHUB_OUTPUT"
            echo "Tag ${TAG} already exists: skipping release."
          else
            echo "release_needed=true" >> "$GITHUB_OUTPUT"
            echo "Tag ${TAG} not found: release will be created."
          fi

      - name: Create tag
        if: steps.version.outputs.release_needed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create release zip
        if: steps.version.outputs.release_needed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          rm -f zentik_notifier.zip
          zip -r zentik_notifier.zip custom_components/zentik_notifier

      - name: Create GitHub Release + upload asset
        if: steps.version.outputs.release_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: zentik_notifier.zip
